# 审计通SQL

## 财务账

#### 会计科目级次

```sql
select max(KJKMJC) from KJKM where KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa'
```

#### 待选会计科目

```sql
with 
A as (
	select distinct km.KJKMBM,km.KJKMMC,km.KJKMJC,km.SJKMBM from KJKM km where km.KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' and kjtx='01'
),
B as (
	select distinct km.KJKMBM,km.KJKMMC,km.KJKMJC,km.SJKMBM from KJKM km where km.KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' and kjtx='02'
),
C as (
	select A.* from A left join B on A.KJKMBM=B.KJKMBM where B.KJKMbm is null
),
D as (
	select B.* from B left join A on A.KJKMBM=B.KJKMBM where A.kjkmbm is null
),
F as (
	select A.* from A inner join B on A.KJKMBM=B.KJKMBM 
)

select * from (
	select * from C
	union all
	select * from D
	union all
	select * from F
) t order by t.kjkmbm
```

#### 记账凭证目录

```sql
with 
A1 as (
	SELECT kjnd, dwdm, kjdzzbbh, kjyf, jzlxbh
         , kjtx, cast(jzpzbh as int) jzpzbh, cast(min(jzpzhh) as int) as jzpzhh
         , sum(jffse) as jffse, sum(dffse) as dffse
	FROM JZPZ
	WHERE kjdzzbbh='7275c6c9_6d2d_26ca_e7e1_71d2bfd058df' and kjtx='01'
	GROUP BY kjnd, dwdm, kjdzzbbh, kjyf, jzlxbh, KJTX, jzpzbh
),
B1 as (
	SELECT kjnd, dwdm, kjdzzbbh, kjyf, jzlxbh
         , kjtx, cast(jzpzbh as int) jzpzbh, cast(min(jzpzhh) as int) as jzpzhh
         , sum(jffse) as jffse, sum(dffse) as dffse
	FROM JZPZ
	WHERE kjdzzbbh='7275c6c9_6d2d_26ca_e7e1_71d2bfd058df' and kjtx='02'
	GROUP BY kjnd, dwdm, kjdzzbbh, kjyf, jzlxbh, KJTX, jzpzbh
),
A as (
	SELECT s.kjnd, s.dwdm, s.kjdzzbbh
				, s.kjyf, s.jzlxbh, t.jzlxmc, t.jzpzrq, s.kjtx
				, s.jzpzbh, t.fjs, s.jffse, s.dffse
				, t.jzpzzy, t.zdry, t.fhry, t.jzry
	FROM A1 s LEFT JOIN JZPZ t
		ON s.kjnd = t.kjnd
		AND s.dwdm = t.dwdm
		AND s.kjdzzbbh = t.kjdzzbbh
		AND s.kjyf = t.kjyf
		AND s.KJTX = t.KJTX
		AND s.jzpzbh = t.jzpzbh
		AND s.jzpzhh = t.JZPZHH
),
B as (
	SELECT s.kjnd, s.dwdm, s.kjdzzbbh
			, s.kjyf, s.jzlxbh, t.jzlxmc, t.jzpzrq, s.kjtx
			, s.jzpzbh, t.fjs, s.jffse, s.dffse
			, t.jzpzzy, t.zdry, t.fhry, t.jzry
	FROM B1 s LEFT JOIN JZPZ t
		ON s.kjnd = t.kjnd
		AND s.dwdm = t.dwdm
		AND s.kjdzzbbh = t.kjdzzbbh
		AND s.kjyf = t.kjyf
		AND s.jzlxbh = t.jzlxbh
		AND s.KJTX = t.KJTX
		AND s.jzpzbh = t.jzpzbh
		AND s.jzpzhh = t.JZPZHH
),
C as (
	select A.*,A.JFFSE cwje,B.JFFSE ysje from A left join B on A.kjnd = B.kjnd
		AND A.dwdm = B.dwdm
		AND A.kjdzzbbh = B.kjdzzbbh
		AND A.kjyf = B.kjyf  
		AND A.jzpzbh = B.jzpzbh where B.kjnd is null
),
F as (
	select B.*,A.JFFSE cwje,B.JFFSE ysje from B INNER join A on A.kjnd = B.kjnd
		AND A.dwdm = B.dwdm
		AND A.kjdzzbbh = B.kjdzzbbh
		AND A.kjyf = B.kjyf  
		AND A.jzpzbh = B.jzpzbh
),
D as (
	select B.*,A.JFFSE cwje,B.JFFSE ysje from B left join A on A.kjnd = B.kjnd
		AND A.dwdm = B.dwdm
		AND A.kjdzzbbh = B.kjdzzbbh
		AND A.kjyf = B.kjyf  
		AND A.jzpzbh = B.jzpzbh where A.kjnd is null
)
select * from (
	select * from C
	union all
	select * from F
	union all
	select * from D
) t order by kjyf,jzpzbh

```

#### 凭证目录穿透

```sql
with 
A as (
	SELECT kjnd, dwdm, kjdzzbbh, kjkmbm
			, kjyf, jzlxbh, jzpzhh, jzlxmc, jzpzrq, kjtx
			, jzpzbh, fjs, jffse, dffse
			, jzpzzy, zdry, fhry, jzry
	from jzpz 
	where KJDZZBBH='22df6668_7a57_7ce0_1950_5f0bc4447b47' and kjyf='1' and JZPZBH='1' and kjtx='02'
)
select A.*,km.kjkmmc from A 
left join KJKM km on A.kjnd=km.kjnd and A.DWDM=km.DWDM and A.KJDZZBBH=km.KJDZZBBH and A.kjkmbm=km.kjkmbm
order by cast(A.jzpzhh as int)
;
```

#### 记账凭证明细

```sql
select * from pzfzmx WHERE kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and kjyf='1' and JZPZBH='1' and kjtx='01' and jzpzhh=32 order by FZBM

```

#### 明细账期初账

```sql
with A as (
	select kjnd, dwdm, kjdzzbbh,kjyf,kjkmbm,kjtx,yefx,
	(case when yefx='1' then sum(bbqcye) else 0 end) jffse,
	(case when yefx='-1' then sum(bbqcye) else 0 end) dffse
	from FZNCS where KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' 
	group by kjnd, dwdm, kjdzzbbh,kjyf,kjkmbm,kjtx,yefx
)
select kjnd, dwdm, kjdzzbbh,kjyf,kjkmbm,kjtx,sum(jffse) jffse,sum(dffse) dffse
from A
group by kjnd, dwdm, kjdzzbbh,kjyf,kjkmbm,kjtx
;
```

#### 明细账每月所有账

```sql
select kjnd, dwdm, kjdzzbbh
			, kjyf, jzlxbh, jzlxmc, jzpzrq, kjtx,kjkmbm
			, jzpzbh,jzpzhh,fjs, jffse, dffse
			, jzpzzy, zdry, fhry, jzry 
from jzpz where KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' 
order by kjyf,cast(jzpzbh as int),cast(jzpzhh as int);

```

#### 余额汇总表

```sql
with 
A as (
	select distinct km.KJKMBM,km.KJKMMC,km.KJKMJC,km.SJKMBM from KJKM km where km.KJDZZBBH='22df6668_7a57_7ce0_1950_5f0bc4447b47' and kjtx='01'
),
B as (
	select distinct km.KJKMBM,km.KJKMMC,km.KJKMJC,km.SJKMBM from KJKM km where km.KJDZZBBH='22df6668_7a57_7ce0_1950_5f0bc4447b47' and kjtx='02'
),
C as (
	select A.* from A left join B on A.KJKMBM=B.KJKMBM where B.KJKMbm is null
),
D as (
	select B.* from B left join A on A.KJKMBM=B.KJKMBM where A.kjkmbm is null
),
F as (
	select A.* from A inner join B on A.KJKMBM=B.KJKMBM 
),
KM as (
	select * from C
	union all
	select * from D
	union all
	select * from F
)
select KM.*
,qc.qcjfye,qc.qcdfye
,qm.qmjfye,qm.qmdfye 
,qm.dfljfse,qm.jfljfse
,(select sum(jffse) from KMYE ye where KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' and  km.kjkmbm=ye.kjkmbm  and (kjyf >= 1 and kjyf <= 4)) bqjffse
,(select sum(dffse) from KMYE ye where KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' and  km.kjkmbm=ye.kjkmbm  and (kjyf >= 1 and kjyf <= 4)) bqdffse
from KM km
left join KMYE qc on qc.KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' and km.kjkmbm=qc.kjkmbm and qc.kjyf=1
left join KMYE qm on qm.KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' and km.kjkmbm=qm.kjkmbm and qm.kjyf=12
;

```

#### 总分类账

```sql
with 
A as (
	select distinct km.KJKMBM,km.KJKMMC,km.KJKMJC,km.SJKMBM from KJKM km where km.KJDZZBBH='22df6668_7a57_7ce0_1950_5f0bc4447b47' and kjtx='01'
),
B as (
	select distinct km.KJKMBM,km.KJKMMC,km.KJKMJC,km.SJKMBM from KJKM km where km.KJDZZBBH='22df6668_7a57_7ce0_1950_5f0bc4447b47' and kjtx='02'
),
C as (
	select A.* from A left join B on A.KJKMBM=B.KJKMBM where B.KJKMbm is null
),
D as (
	select B.* from B left join A on A.KJKMBM=B.KJKMBM where A.kjkmbm is null
),
F as (
	select A.* from A inner join B on A.KJKMBM=B.KJKMBM 
),
KM as (
	select * from C
	union all
	select * from D
	union all
	select * from F
)
select KM.*,ye.jffse,ye.dffse,ye.kjyf,ye.qmjfye,ye.qmdfye,(ye.qmjfye-ye.qmdfye) qmye
from KM km
left join KMYE ye on ye.KJDZZBBH='f7f9159e_2ba4_227f_c369_1c60f5cb58fa' and km.kjkmbm=ye.kjkmbm
order by km.kjkmbm,ye.kjyf
;

```

## 辅助帐

#### 辅助类型名称

```sql
--辅助项类型
select * from FZLX where kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' order by cast(fzlxbm as int)
```

#### 辅助帐辅助科目选择

```
--选择辅助项
select distinct t.fzbm,t.fzmc,t.kjtx,f.FZJC from (
	select distinct fzbm,fzmc,kjtx from PZFZMX where kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and FZBM LIKE '1-%'
	union all
	select distinct fzbm,fzmc,kjtx from FZNCS where kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and FZBM LIKE '1-%'
) t
left join FZXX f on f.kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and t.fzbm=f.fzbm
order by t.kjtx,t.fzbm
```

#### 辅助会计科目选择

```sql
--选择辅助科目
select distinct t.kjkmbm,t.kjkmmc,t.kjtx,k.kjkmjc from (
	select distinct kjkmbm,kjkmmc,kjtx from PZFZMX where kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and FZBM LIKE '1-%'
	union all
	select distinct kjkmbm,kjkmmc,kjtx from FZNCS where kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and FZBM LIKE '1-%' 
) t
left join kjkm k on k.kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and t.kjkmbm=k.kjkmbm
order by kjtx,kjkmbm
```

#### 辅助明细账期初账

```sql
--期初(-1：贷方，1：借方)
with A as (
	select kjnd, dwdm, kjdzzbbh,kjyf,kjkmbm,fzbm,kjtx,yefx,
	(case when yefx='1' then sum(bbqcye) else 0 end) jffse,
	(case when yefx='-1' then sum(bbqcye) else 0 end) dffse
	from FZNCS where KJDZZBBH='22df6668_7a57_7ce0_1950_5f0bc4447b47' 
	group by kjnd, dwdm, kjdzzbbh,kjyf,kjkmbm,fzbm,kjtx,yefx
)
select kjnd, dwdm, kjdzzbbh,kjyf,kjkmbm,fzbm,kjtx,sum(jffse) jffse,sum(dffse) dffse
from A
--where kjkmbm like '50010102%' and fzbm like '1-00%'
group by kjnd, dwdm, kjdzzbbh,kjyf,kjkmbm,fzbm,kjtx
```

#### 辅助帐明细账

```sql
--辅助明细账
select j.jzpzrq,p.* from PZFZMX p 
left join jzpz j on j.kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and p.kjtx=j.kjtx and p.kjyf=j.kjyf and p.jzpzbh=j.jzpzbh and p.jzpzhh=j.jzpzhh
where p.kjdzzbbh='22df6668_7a57_7ce0_1950_5f0bc4447b47' and p.kjkmbm like '50010102%' and p.fzbm like '1-00%'
order by p.kjyf,cast(p.jzpzbh as int),cast(p.jzpzhh as int)
```

